{% extends "base.html" %}
{% block title %}Trade BTC{% endblock %}
{% block content %}
    <div class="trade-container">
        <h2>Trade BTC/USDT</h2>
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="flash-messages">
                    {% for message in messages %}
                        <p class="flash-message">{{ message }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        <div class="stats">
            <p>PUK Balance: {{ puk_balance|round(2) }} PUK</p>
            <p>PUK Price: {{ puk_price|round(2) }} USDT</p>
            <p>BTC Price: {{ btc_price|round(2) }} USDT</p>
        </div>
        <div class="chart-container">
            <canvas id="priceChart"></canvas>
            <div class="timeframe-buttons">
                <button onclick="updateChart('1m')">1m</button>
                <button onclick="updateChart('5m')">5m</button>
                <button onclick="updateChart('30m')">30m</button>
                <button onclick="updateChart('1h')">1h</button>
                <button onclick="updateChart('4h')">4h</button>
                <button onclick="updateChart('8h')">8h</button>
                <button onclick="updateChart('1w')">1w</button>
            </div>
        </div>
        <div class="trade-form">
            <form method="POST">
                <input type="hidden" name="action" id="tradeAction">
                <input type="hidden" name="percentage" id="percentageField">  <!-- Hidden field for percentage -->
                <div class="trade-inputs">
                    <div class="buy-sell">
                        <div>
                            <h3>Buy BTC</h3>
                            <input type="number" name="buy_amount" id="buyAmount" placeholder="Amount to Buy" min="0.01" step="0.01">
                        </div>
                        <div class="percentage-buttons">
                            {% for percent in [10, 20, 30, 50, 60, 70, 80, 90, 100] %}
                                <button type="button" onclick="setPercentage('buy', {{ percent }})">{{ percent }}%</button>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="buy-sell">
                        <div>
                            <h3>Sell BTC</h3>
                            <input type="number" name="sell_amount" id="sellAmount" placeholder="Amount to Sell" min="0.01" step="0.01">
                        </div>
                        <div class="percentage-buttons">
                            {% for percent in [10, 20, 30, 50, 60, 70, 80, 90, 100] %}
                                <button type="button" onclick="setPercentage('sell', {{ percent }})">{{ percent }}%</button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="submit-button">
                    <button type="submit" onclick="document.getElementById('tradeAction').value='buy'; document.getElementById('percentageField').value = 100;">Buy BTC</button>
                    <button type="submit" onclick="document.getElementById('tradeAction').value='sell'; document.getElementById('percentageField').value = 100;">Sell BTC</button>
                </div>
            </form>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById('priceChart').getContext('2d');
        let chart = new Chart(ctx, {
            type: 'candlestick',
            data: { datasets: [{ label: 'BTC/USDT', data: [] }] },
            options: { scales: { x: { time: { unit: 'minute' } }, y: { beginAtZero: false } } }
        });

        function updateChart(timeframe) {
            fetch(`/api/klines/${timeframe}`)
                .then(response => response.json())
                .then(data => {
                    const chartData = data.map(d => ({
                        x: new Date(parseInt(d[0])),
                        o: parseFloat(d[1]),
                        h: parseFloat(d[2]),
                        l: parseFloat(d[3]),
                        c: parseFloat(d[4])
                    }));
                    chart.data.datasets[0].data = chartData;
                    chart.options.scales.x.time.unit = timeframe === '1w' ? 'week' : timeframe === '1m' ? 'minute' : 'hour';
                    chart.update();
                });
        }
        updateChart('1h'); // เริ่มต้นที่ 1 ชั่วโมง

        function setPercentage(type, percent) {
            const amountField = type === 'buy' ? document.getElementById('buyAmount') : document.getElementById('sellAmount');
            const availableAmount = type === 'buy' ? {{ puk_balance }} : {{ btc_balance }}; // ใส่ข้อมูลจำนวนที่มีอยู่จริง
            const calculatedAmount = (availableAmount * percent / 100).toFixed(2);
            amountField.value = calculatedAmount;

            // Update the hidden field to pass the percentage
            document.getElementById('percentageField').value = percent;
        }
    </script>
{% endblock %}
